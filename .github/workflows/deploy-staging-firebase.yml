name: Deploy Frontend to Firebase Hosting (Staging)

on:
  push:
    branches:
      - develop # Acionado por push na branch 'develop'
    paths:
      - 'src/**'
      - 'public/**'
      - 'index.html'
      - 'package.json'
      - 'vite.config.js'

jobs:
  build_and_deploy_staging:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout GestaoRPD Repository
        uses: actions/checkout@v3
        with:
          ref: develop # Garante que estamos usando o c√≥digo da branch 'develop'

      - name: 2. Checkout Shared Assets Repository
        uses: actions/checkout@v3
        with:
          repository: CidQueiroz/cdkteck-assets
          token: ${{ secrets.ASSETS_REPO_TOKEN }}
          path: ./.temp-assets

      - name: 3. Copy Shared Assets to Public Folder
        run: |
          echo "Copying shared assets..."
          mkdir -p public/assets
          mkdir -p public/components
          cp -r ./.temp-assets/* public/
          echo "Assets copied successfully."
          ls -R public/

      - name: 4. Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: 5. Install Dependencies
        run: npm install

      - name: 6. Build Project
        run: npm run build

      - name: 7. Deploy to Firebase Staging Channel
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_CDKTECK_HUB }}'
          projectId: senseidb-rebranding
          target: gestaorpd
          channelId: staging # Faz o deploy para um canal de preview chamado 'staging'
