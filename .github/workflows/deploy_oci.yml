# Nome do nosso robô (workflow)
name: Tentar Criar Instância OCI

# Gatilhos: Quando o robô deve acordar e trabalhar
on:
  # 1. De hora em hora, automaticamente
  schedule:
    - cron: '0 * * * *' # A sintaxe 'cron' para "no minuto 0, de toda hora"
  
  # 2. Permite que você o acione manualmente pela interface do GitHub
  workflow_dispatch:

# Tarefas: O que o robô deve fazer
jobs:
  deploy:
    # O tipo de computador que o robô usará (um Ubuntu)
    runs-on: ubuntu-latest

    # AQUI ESTÁ A CORREÇÃO: Define o diretório de trabalho padrão para todos os passos deste job
    defaults:
      run:
        working-directory: Terraform_OCI

    steps:
      # Passo 1: O robô pega uma cópia das suas "plantas baixas" (o código do repo)
      - name: Checkout do código
        uses: actions/checkout@v4

      # Passo 2: O robô pega a "caixa de ferramentas" do Terraform
      - name: Setup do Terraform
        uses: hashicorp/setup-terraform@v3

      # Passo 3: O robô executa os comandos do Terraform
      # Passo 3: O robô executa os comandos do Terraform
      - name: Executar Terraform
        run: |
          # Primeiro, criamos o arquivo da chave a partir do secret
          echo "${{ secrets.OCI_PRIVATE_KEY }}" | base64 --decode > oci_api_key_temp.pem
          chmod 600 oci_api_key_temp.pem

          # Agora, com o arquivo criado, rodamos o Terraform
          terraform init
          terraform apply -auto-approve
        env:
          # Variáveis para autenticação do provedor OCI
          OCI_TENANCY_OCID: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_USER_OCID: ${{ secrets.OCI_USER_OCID }}
          OCI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_REGION: sa-saolo-1
          
          # AQUI ESTÁ A LÓGICA CORRETA:
          # Apontamos a variável de ambiente para o arquivo que acabamos de criar no passo 'run'
          OCI_PRIVATE_KEY_PATH: "oci_api_key_temp.pem"